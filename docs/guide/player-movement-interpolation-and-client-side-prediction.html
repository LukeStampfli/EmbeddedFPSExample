<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Player-Movement, Interpolation and Client Side Prediction | EmbeddedFPSExample</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/EmbeddedFPSExample/assets/css/0.styles.32e58400.css" as="style"><link rel="preload" href="/EmbeddedFPSExample/assets/js/app.debd0cf8.js" as="script"><link rel="preload" href="/EmbeddedFPSExample/assets/js/2.6b282e9d.js" as="script"><link rel="preload" href="/EmbeddedFPSExample/assets/js/16.92f92ea2.js" as="script"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/10.021f36e7.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/11.710a60b5.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/12.dabfb87e.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/13.6ea62ec4.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/14.62a0b14a.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/15.e4fe2066.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/17.a10b7396.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/18.1f2cce65.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/19.c0a5a8eb.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/20.2f1b2705.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/3.2e9c32b1.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/4.5667f98c.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/5.a89d39a3.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/6.1e5c2305.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/7.237b2ecd.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/8.20703bf5.js"><link rel="prefetch" href="/EmbeddedFPSExample/assets/js/9.7cddb3eb.js">
    <link rel="stylesheet" href="/EmbeddedFPSExample/assets/css/0.styles.32e58400.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/EmbeddedFPSExample/" class="home-link router-link-active"><!----> <span class="site-name">EmbeddedFPSExample</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/EmbeddedFPSExample/guide/introduction.html" class="sidebar-link">Introduction</a></li><li><a href="/EmbeddedFPSExample/guide/setting-up-the-projects.html" class="sidebar-link">Setting up the projects</a></li><li><a href="/EmbeddedFPSExample/guide/client-basics-and-login-system-part-1.html" class="sidebar-link">Client Basics and Login System Part 1</a></li><li><a href="/EmbeddedFPSExample/guide/server-basics-and-login-system.html" class="sidebar-link">Server Basics and Login System</a></li><li><a href="/EmbeddedFPSExample/guide/room-system-part-1-server-side.html" class="sidebar-link">Room System Part 1 (Server-Side)</a></li><li><a href="/EmbeddedFPSExample/guide/client-login-system-part-2-and-lobby.html" class="sidebar-link">Client Login System Part 2 and Lobby</a></li><li><a href="/EmbeddedFPSExample/guide/room-system-part-2-server-side.html" class="sidebar-link">Room System Part 2 (Server-Side)</a></li><li><a href="/EmbeddedFPSExample/guide/player-movement-interpolation-and-client-side-prediction.html" aria-current="page" class="active sidebar-link">Player-Movement, Interpolation and Client Side Prediction</a></li><li><a href="/EmbeddedFPSExample/guide/multiplayer-gameplay.html" class="sidebar-link">Multiplayer Gameplay (Synchronization and Buffers)</a></li><li><a href="/EmbeddedFPSExample/guide/reconciliation.html" class="sidebar-link">Reconciliation</a></li><li><a href="/EmbeddedFPSExample/guide/health-shooting-lag-Compensation.html" class="sidebar-link">Health, Shooting, Lag Compensation</a></li><li><a href="/EmbeddedFPSExample/guide/networking-discussion.html" class="sidebar-link">Networking Discussion</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="player-movement-interpolation-and-client-side-prediction"><a href="#player-movement-interpolation-and-client-side-prediction" class="header-anchor">#</a> Player-Movement, Interpolation and Client Side Prediction</h1> <p>Player movement in multiplayer games is a bit more commplicated then in singleplayer games. To make it feel snappy a lot of games need to move the player immediately
on the client side. On the other hand if our game is competitive we want to make sure that players can't cheat by sending illegal movement to the server.
We achieve this in the following way:</p> <ul><li>Movement is done in a fixed time step. That way the distance a player can move is the same on any machine regardless of their framerate.</li> <li>Client and server both run the same movemenment code. This gives us accurate prediction</li> <li>If Server and client end up with different results we always take the servers result.</li></ul> <p>Let's start by implementing a function which moves the player based on input. That function should run on the client and the server, so that the client can predict his movement.</p> <p>Let's first define what our player input will be and create a struct to represent it. We will also make it a IDarkriftSerializable so that we can send it to the server later. For our FPS we will need to monitor the following key inputs: W, A, S, D, Space, LeftClick we will store them in a bool[] (true means key is down false means key is up). But in additon to that we need the look direction of the player because his walk and shoot directions depend on it. (We will store the exact look direction and not just the delta).</p> <p>So let's create a struct in the Networking Data script:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">PlayerInputData</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDarkRiftSerializable</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">bool</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> Keyinputs<span class="token punctuation">;</span> <span class="token comment">// 0 = w, 1 = a, 2 = s, 3 = d, 4 = space, 5 = leftClick</span>
    <span class="token keyword">public</span> <span class="token class-name">Quaternion</span> LookDirection<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">uint</span></span> Time<span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token function">PlayerInputData</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">bool</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> keyInputs<span class="token punctuation">,</span> <span class="token class-name">Quaternion</span> lookdirection<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">uint</span></span> time<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Keyinputs <span class="token operator">=</span> keyInputs<span class="token punctuation">;</span>
        LookDirection <span class="token operator">=</span> lookdirection<span class="token punctuation">;</span>
        Time <span class="token operator">=</span> time<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Deserialize</span><span class="token punctuation">(</span><span class="token class-name">DeserializeEvent</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Keyinputs <span class="token operator">=</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadBooleans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        LookDirection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Quaternion</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Keyinputs<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Time <span class="token operator">=</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadUInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token class-name">SerializeEvent</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
 
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>Keyinputs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>LookDirection<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>LookDirection<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>LookDirection<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>LookDirection<span class="token punctuation">.</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Keyinputs<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>Time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We will use the Time field in the input later for lag compensation so you can igore it for now.</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>There are far better ways to write booleans or quaternions which use less bandwidth, which i'm not going to explain here. You can take a look at a <a href="https://github.com/LestaAllmaron/DarkriftSerializationExtensions/blob/master/DarkriftSerializationExtensions/DarkriftSerializationExtensions/SerializationExtensions.cs" target="_blank" rel="noopener noreferrer">script of mine<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to see examples on how to write bools or quaternions.</p></div> <p>We will also need a struct to represent a player state (his position and rotation) we will also use this struct to sync player data in general so it will also contain the id of the player:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">PlayerStateData</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDarkRiftSerializable</span></span>
<span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token function">PlayerStateData</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">ushort</span></span> id<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">float</span></span> gravity<span class="token punctuation">,</span> <span class="token class-name">Vector3</span> position<span class="token punctuation">,</span> <span class="token class-name">Quaternion</span> lookDirection<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Id <span class="token operator">=</span> id<span class="token punctuation">;</span>
        Position <span class="token operator">=</span> position<span class="token punctuation">;</span>
        LookDirection <span class="token operator">=</span> lookDirection<span class="token punctuation">;</span>
        Gravity <span class="token operator">=</span> gravity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">ushort</span></span> Id<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Vector3</span> Position<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">float</span></span> Gravity<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Quaternion</span> LookDirection<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Deserialize</span><span class="token punctuation">(</span><span class="token class-name">DeserializeEvent</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Position <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Vector3</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        LookDirection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Quaternion</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Id <span class="token operator">=</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadUInt16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Gravity <span class="token operator">=</span> e<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">ReadSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token class-name">SerializeEvent</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>Position<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>Position<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>Position<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>LookDirection<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>LookDirection<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>LookDirection<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>LookDirection<span class="token punctuation">.</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>Gravity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now we are ready to create our player.</p> <ul><li>Create a ClientPlayer script in the Scripts folder</li> <li>Create a PlayerLogic script in the <strong>Scripts/Shared</strong> folder</li> <li>Create a new &quot;Game&quot; scene and open it.</li> <li>Create a new plane and scale it up to (5,5,5)</li> <li>Create a new empty gameobject name it &quot;Player&quot;.</li> <li>Add a CharacterController to the player and set its height to 0</li> <li>Add The ClientPlayer and the PlayerLogic script to the Player gameobject.</li> <li>Create a Sphere as a child of the Player(this will be our visual representation)</li></ul> <p>Now let's start by writing the PlayerLogic which is a shared script between the client and the server. We will use the player logic script to calculate the next position of the player based on an input.</p> <p>first of all add some variables</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">UnityEngine</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">RequireComponent</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">CharacterController</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PlayerLogic</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">MonoBehaviour</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Vector3</span> gravity<span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Header</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;Settings&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">SerializeField</span></span><span class="token punctuation">]</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">float</span></span> walkSpeed<span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">SerializeField</span></span><span class="token punctuation">]</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">float</span></span> gravityConstant<span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">SerializeField</span></span><span class="token punctuation">]</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">float</span></span> jumpStrength<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">CharacterController</span> CharacterController <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Awake</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        CharacterController <span class="token operator">=</span> <span class="token generic-method"><span class="token function">GetComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>CharacterController<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Now we want a function to <span class="token keyword">get</span> the next PlayerStateData depending <span class="token keyword">on</span> a InputData<span class="token punctuation">.</span> Something like <span class="token keyword">this</span><span class="token punctuation">:</span>

```csharp
    <span class="token keyword">public</span> <span class="token return-type class-name">PlayerStateData</span> <span class="token function">GetNextFrameData</span><span class="token punctuation">(</span><span class="token class-name">PlayerInputData</span> input<span class="token punctuation">,</span> <span class="token class-name">PlayerStateData</span> currentStateData<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>inside that function let's first get our inputs:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>        <span class="token class-name"><span class="token keyword">bool</span></span> w <span class="token operator">=</span> input<span class="token punctuation">.</span>Keyinputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">bool</span></span> a <span class="token operator">=</span> input<span class="token punctuation">.</span>Keyinputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">bool</span></span> s <span class="token operator">=</span> input<span class="token punctuation">.</span>Keyinputs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">bool</span></span> d <span class="token operator">=</span> input<span class="token punctuation">.</span>Keyinputs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">bool</span></span> space <span class="token operator">=</span> input<span class="token punctuation">.</span>Keyinputs<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>Calculating the next rotation is very easy we just take the one the player gives us. (working with rotation delta values is ugly and it doesn't prevent players from cheating so there is no reason to do it)</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>        <span class="token class-name">Vector3</span> rotation <span class="token operator">=</span>  input<span class="token punctuation">.</span>LookDirection<span class="token punctuation">.</span>eulerAngles<span class="token punctuation">;</span>
</code></pre></div><p>we also define a gravity vector:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>        gravity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> currentStateData<span class="token punctuation">.</span>Gravity<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The next step is movement. We want our player to move depending on his y rotation and the WASD inputs. A possible implementation is this:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>        <span class="token class-name">Vector3</span> movement <span class="token operator">=</span> Vector3<span class="token punctuation">.</span>zero<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>w<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            movement <span class="token operator">+=</span> Vector3<span class="token punctuation">.</span>forward<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            movement <span class="token operator">+=</span> Vector3<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            movement <span class="token operator">+=</span> Vector3<span class="token punctuation">.</span>back<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            movement <span class="token operator">+=</span> Vector3<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        movement <span class="token operator">=</span> Quaternion<span class="token punctuation">.</span><span class="token function">Euler</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> rotation<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> movement<span class="token punctuation">;</span> <span class="token comment">// Move towards the look direction.</span>
        movement<span class="token punctuation">.</span><span class="token function">Normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        movement <span class="token operator">=</span> movement <span class="token operator">*</span> walkSpeed<span class="token punctuation">;</span>

        movement <span class="token operator">=</span> movement <span class="token operator">*</span> Time<span class="token punctuation">.</span>fixedDeltaTime<span class="token punctuation">;</span>
        movement <span class="token operator">=</span> movement <span class="token operator">+</span> gravity <span class="token operator">*</span> Time<span class="token punctuation">.</span>fixedDeltaTime<span class="token punctuation">;</span>
</code></pre></div><p>Now we have to move our character controller to detect any collisions. But before that we need a little fix because the character controller isn't very reliable. So just add:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>        CharacterController<span class="token punctuation">.</span><span class="token function">Move</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.001f</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Well just Unity things, anyways...</p> <p>Add logic to handle jumping:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>        <span class="token keyword">if</span> <span class="token punctuation">(</span>CharacterController<span class="token punctuation">.</span>isGrounded<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>space<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                gravity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> jumpStrength<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            gravity <span class="token operator">-=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> gravityConstant<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre></div><p>Finally we can move the CharacterController and return the result as a new PlayerStateData:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>        CharacterController<span class="token punctuation">.</span><span class="token function">Move</span><span class="token punctuation">(</span>movement<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PlayerStateData</span><span class="token punctuation">(</span>currentStateData<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> gravity<span class="token punctuation">.</span>y<span class="token punctuation">,</span> transform<span class="token punctuation">.</span>localPosition<span class="token punctuation">,</span> input<span class="token punctuation">.</span>LookDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now we can calculate the next position of any player depending on our input. We should test if it works locally in the ClientPlayer script.</p> <p>So open the ClientPlayer script and add the following:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">RequireComponent</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">PlayerLogic</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientPlayer</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">MonoBehaviour</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">PlayerLogic</span> playerLogic<span class="token punctuation">;</span>

    <span class="token comment">// Store look direction.</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">float</span></span> yaw<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">float</span></span> pitch<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">ushort</span></span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">string</span></span> playerName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">bool</span></span> isOwn<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">int</span></span> health<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">PlayerStateData</span> playerStateData<span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Header</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;Settings&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">SerializeField</span></span><span class="token punctuation">]</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">float</span></span> sensitivityX<span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">SerializeField</span></span><span class="token punctuation">]</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">float</span></span> sensitivityY<span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Awake</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        playerLogic <span class="token operator">=</span> <span class="token generic-method"><span class="token function">GetComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>PlayerLogic<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre></div><p>The id is the id of the player on the server and isOwn is be true for our own player but not for enemies.
The sensitivity, yaw and pitch variables will be used to rotate the camera based on the mouse movements.</p> <p>First let's attach the camera to our player. (we do that by script because we later want to attach the camera to our own player).</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    Camera<span class="token punctuation">.</span>main<span class="token punctuation">.</span>transform<span class="token punctuation">.</span><span class="token function">SetParent</span><span class="token punctuation">(</span>transform<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Camera<span class="token punctuation">.</span>main<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>localPosition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Camera<span class="token punctuation">.</span>main<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>localRotation <span class="token operator">=</span> Quaternion<span class="token punctuation">.</span>identity<span class="token punctuation">;</span>
    
    playerStateData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PlayerStateData</span><span class="token punctuation">(</span>Id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Vector3<span class="token punctuation">.</span>zero<span class="token punctuation">,</span> Quaternion<span class="token punctuation">.</span>identity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now we can create a simple logic to read inputs and perform movement in FixedUpdate:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">FixedUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
            <span class="token keyword">bool</span><span class="token punctuation">[</span><span class="token punctuation">]</span>inputs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">bool</span></span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> Input<span class="token punctuation">.</span><span class="token function">GetKey</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>W<span class="token punctuation">)</span><span class="token punctuation">;</span>
            inputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> Input<span class="token punctuation">.</span><span class="token function">GetKey</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>A<span class="token punctuation">)</span><span class="token punctuation">;</span>
            inputs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> Input<span class="token punctuation">.</span><span class="token function">GetKey</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>S<span class="token punctuation">)</span><span class="token punctuation">;</span>
            inputs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> Input<span class="token punctuation">.</span><span class="token function">GetKey</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>D<span class="token punctuation">)</span><span class="token punctuation">;</span>
            inputs<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> Input<span class="token punctuation">.</span><span class="token function">GetKey</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>Space<span class="token punctuation">)</span><span class="token punctuation">;</span>
            inputs<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> Input<span class="token punctuation">.</span><span class="token function">GetMouseButton</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            yaw <span class="token operator">+=</span> Input<span class="token punctuation">.</span><span class="token function">GetAxis</span><span class="token punctuation">(</span><span class="token string">&quot;Mouse X&quot;</span><span class="token punctuation">)</span> <span class="token operator">*</span> sensitivityX<span class="token punctuation">;</span>
            pitch <span class="token operator">+=</span> Input<span class="token punctuation">.</span><span class="token function">GetAxis</span><span class="token punctuation">(</span><span class="token string">&quot;Mouse Y&quot;</span><span class="token punctuation">)</span> <span class="token operator">*</span> sensitivityY<span class="token punctuation">;</span>

            <span class="token class-name">Quaternion</span> rotation <span class="token operator">=</span> Quaternion<span class="token punctuation">.</span><span class="token function">Euler</span><span class="token punctuation">(</span>pitch<span class="token punctuation">,</span> yaw<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">PlayerInputData</span> inputData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PlayerInputData</span><span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> rot<span class="token punctuation">,</span> <span class="token number">0</span><span class="token comment">/*here we later synchronize the last recieved tick number from the server*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">PlayerStateData</span> nextStateData <span class="token operator">=</span> Logic<span class="token punctuation">.</span><span class="token function">GetNextFrameData</span><span class="token punctuation">(</span>inputData<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            transform<span class="token punctuation">.</span>rotation <span class="token operator">=</span> data<span class="token punctuation">.</span>LookDirection<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>This is already enough to move our player. We don't have to set the position after calculating it since the character controller does that for us already.</p> <p>Go into Unity assign the reference to the PlayerLogic and set walkSpeed = 8, GravityConstant = 2, JumpStrength = 11 and in the ClientPlayer script set SensivityX to 5 and SensivityY to -5.</p> <p>You can press play now and run around with your character. But you may realize that there is something wrong. The movement might feel jittered. The reason for that is that we just sample inputs at our fixed rate (50 times per second as default), this means on certain frames we might get multiple movement updates and on other frames none. We wan't our movement to be smooth. This is done with interpolation which we will implement next.</p> <p>Create a new PlayerInterpolation script in the Scripts folder and open it.</p> <p>Basic interpolation works like this; We store 2 values and use our current time to lerp between the two values. In our case we want to always interpolate on the last two PlayerStateData from our player. (Note that we add a little bit of input delay to our movement by doing this compared to moving instantly in Update. There are other options without a delay (extrapolating) but they come with their own set of challenges. Simple interpolation works very well for most types of multiplayer games.</p> <p>Let's start by defining some fields and properties in the PlayerInterpolation script:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">float</span></span> lastInputTime<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">PlayerStateData</span> CurrentData <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">PlayerStateData</span> PreviousData <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre></div><p>CurrentData will be the last position we moved to and PreviousData the position in the frame before that. We will also keep track of a time value where we store the fixed time of when we updated CurrentData the last time. This value is only relevant if don't get updates for a while in that case we start to predict(extrapolate).</p> <p>Now we can also add a function to set those values or to just input the next value:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetFramePosition</span><span class="token punctuation">(</span><span class="token class-name">PlayerStateData</span> data<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">RefreshToPosition</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> CurrentData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">RefreshToPosition</span><span class="token punctuation">(</span><span class="token class-name">PlayerStateData</span> data<span class="token punctuation">,</span> <span class="token class-name">PlayerStateData</span> prevData<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        PreviousData <span class="token operator">=</span> prevData<span class="token punctuation">;</span>
        CurrentData <span class="token operator">=</span> data<span class="token punctuation">;</span>
        lastInputTime <span class="token operator">=</span> Time<span class="token punctuation">.</span>fixedTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>Now we just have to interpolate in Update:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">float</span></span> timeSinceLastInput <span class="token operator">=</span> Time<span class="token punctuation">.</span>time <span class="token operator">-</span> lastInputTime<span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">float</span></span> t <span class="token operator">=</span> timeSinceLastInput <span class="token operator">/</span> Time<span class="token punctuation">.</span>fixedDeltaTime<span class="token punctuation">;</span>
        transform<span class="token punctuation">.</span>position <span class="token operator">=</span> Vector3<span class="token punctuation">.</span><span class="token function">LerpUnclamped</span><span class="token punctuation">(</span>PreviousData<span class="token punctuation">.</span>Position<span class="token punctuation">,</span> CurrentData<span class="token punctuation">.</span>Position<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        transform<span class="token punctuation">.</span>rotation <span class="token operator">=</span> Quaternion<span class="token punctuation">.</span><span class="token function">SlerpUnclamped</span><span class="token punctuation">(</span>PreviousData<span class="token punctuation">.</span>LookDirection<span class="token punctuation">,</span>CurrentData<span class="token punctuation">.</span>LookDirection<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>Interpolation is very simple in its raw form. we set the as the time since our last input and divide it by fixedDeltaTime. Then we lerp between the last 2 values. We use LerpUnclamped because we don't want players to stop moving when they don't get an input for a while. LerpUnclamped will extrapolate their position if we don't receive updates for a while.</p> <p>Add the PlayerInterpolation to the Player and open the ClientPlayer script and add a field to track the PlayerInterpolation and</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token class-name">PlayerInterpolation</span> interpolation<span class="token punctuation">;</span>
</code></pre></div><p>and remove the following: (We store our PlayerStateData now in the Interpolation class)</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">private</span> <span class="token class-name">PlayerStateData</span> playerStateData<span class="token punctuation">;</span>
</code></pre></div><p>In awake get a reference to our Interpolation by adding</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>        interpolation <span class="token operator">=</span> <span class="token generic-method"><span class="token function">GetComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>PlayerInterpolation<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Finally add a require component Attribute to the ClientPlayer class like this:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">RequireComponent</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">PlayerLogic</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">RequireComponent</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">PlayerInterpolation</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientPlayer</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">MonoBehaviour</span></span>
<span class="token punctuation">{</span>
<span class="token range operator">..</span><span class="token range operator">..</span><span class="token range operator">..</span>
</code></pre></div><p>Next we have to replace our logic which used the playerStateData with the values from our interpolation script. Start in the Start function by replacing:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    playerStateData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PlayerStateData</span><span class="token punctuation">(</span>Id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Vector3<span class="token punctuation">.</span>zero<span class="token punctuation">,</span> Quaternion<span class="token punctuation">.</span>identity<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>with</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    Interpolation<span class="token punctuation">.</span>CurrentData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PlayerStateData</span><span class="token punctuation">(</span>Id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Vector3<span class="token punctuation">.</span>zero<span class="token punctuation">,</span> Quaternion<span class="token punctuation">.</span>identity<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Next search for the following lines in FixedUpdate:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token class-name">PlayerStateData</span> nextStateData <span class="token operator">=</span> Logic<span class="token punctuation">.</span><span class="token function">GetNextFrameData</span><span class="token punctuation">(</span>inputData<span class="token punctuation">,</span> playerStateData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    transform<span class="token punctuation">.</span>rotation <span class="token operator">=</span> playerStateData<span class="token punctuation">.</span>LookDirection<span class="token punctuation">;</span>
</code></pre></div><p>and replace them with:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    transform<span class="token punctuation">.</span>position <span class="token operator">=</span> Interpolation<span class="token punctuation">.</span>CurrentData<span class="token punctuation">.</span>Position<span class="token punctuation">;</span>
    <span class="token class-name">PlayerStateData</span> nextStateData <span class="token operator">=</span> playerLogic<span class="token punctuation">.</span><span class="token function">GetNextFrameData</span><span class="token punctuation">(</span>inputData<span class="token punctuation">,</span> interpolation<span class="token punctuation">.</span>CurrentData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    interpolation<span class="token punctuation">.</span><span class="token function">SetFramePosition</span><span class="token punctuation">(</span>nextStateData<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The first line we added will set the player back to the last calculated position. We must do that because the PlayerInterpolation also moves the player. And at the end with simply inform the interpolation about the new value, that's all  we have to do. If we run now again we can experience 100% smooth movements.</p> <p>Finally let's send that information to the server. So after the replaced lines add:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">Message</span> message <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span>Tags<span class="token punctuation">.</span>GamePlayerInput<span class="token punctuation">,</span> inputData<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        ConnectionManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>Client<span class="token punctuation">.</span><span class="token function">SendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> SendMode<span class="token punctuation">.</span>Reliable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>and add the Tag to the Tags of the Networking Data script:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    GamePlayerInput <span class="token operator">=</span> <span class="token number">203</span><span class="token punctuation">,</span>
</code></pre></div><p>Now we are ready for the server side. In the next section we will spawn players on the server and send information about them to clients, which makes our game finally a real multiplayer game.</p> <p>Your scripts should look now like this:</p> <ul><li><a href="https://github.com/LukeStampfli/EmbeddedFPSExample/tree/master/gists/movement1-NetworkingData.cs" target="_blank" rel="noopener noreferrer">NetworkingData<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/LukeStampfli/EmbeddedFPSExample/tree/master/gists/movement1-PlayerLogic.cs" target="_blank" rel="noopener noreferrer">PlayerLogic<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/LukeStampfli/EmbeddedFPSExample/tree/master/gists/movement1-ClientPlayer.cs" target="_blank" rel="noopener noreferrer">ClientPlayer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/LukeStampfli/EmbeddedFPSExample/tree/master/gists/movement1-PlayerInterpolation.cs" target="_blank" rel="noopener noreferrer">PlayerInterpolation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      
      <a href="/EmbeddedFPSExample/guide/room-system-part-2-server-side.html" class="prev">
        Room System Part 2 (Server-Side)
      </a></span> <span class="next"><a href="/EmbeddedFPSExample/guide/multiplayer-gameplay.html">
        Multiplayer Gameplay (Synchronization and Buffers)
      </a>
      
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/EmbeddedFPSExample/assets/js/app.debd0cf8.js" defer></script><script src="/EmbeddedFPSExample/assets/js/2.6b282e9d.js" defer></script><script src="/EmbeddedFPSExample/assets/js/16.92f92ea2.js" defer></script>
  </body>
</html>
